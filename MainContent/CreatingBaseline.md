---
sort: 7
---

# Baseline 생성
나중에 비교할 기준이 될 수 있도록 주기적으로 성능 데이터를 수집하며 이를 자동화 하는 방법도 같이 설명한다.  
성능모니터에서 로그파일로 저장하는 기능을 예전에는 "카운터 로그" 라고 불렀지만 지금은 "데이터 수집기 집합"이라는 명칭으로 바꼈다. 이 책에서는 카운터 로그라는 명칭으로 설명한다.  
베이스라인 데이터는 해당 SQL Server시스템을 이해하는데 기본적인 필요한 부분이므로 항상 준비될 수 있어야 한다.  

    * 가상 또는 실제 머신을 모니터링 할때 고려사항
    * 성능 모니터의 카운터 로그 데이터 수집하는 자동화된 세팅 방법
    * 성능모니터를 사용할때 조심해야 할 점
    * 베이스라인 만들기

## 7.1 가상 또는 실제 머신을 모니터링 할때 고려사항
최근에는 가상환경에서 SQL Server를 운용하는 경우가 많아지고 있는 추세인데 이유는 다음과 같다.

    * AWS, MS Azure와 같은 퍼플릭 클라우드로 이전하는 회사들이 급격히 증가.
    * 온프레미스에서도 VMWare같은 가상서버에서 SQL Server를 운용하는것을 꺼려하지 않는다.

가상 서버 환경에서 SQL Server를 운용하게 되면 많은 물리적 성능 카운터들이 무의미 해질 수 있기 때문에 예전에는 잘 쓰지 않았다. 하지만 최근에는 위와 같은 이유때문에 많이 사용되고 있으며 정확한 정보를 얻기 위해 추가적인 지표를 모니터링해야 한다.  
그나마 디스크 및 네트워크 항목들은 물리적인 측정치와 비슷한 값을 가져서 큰 문제가 없지만 CPU나 메모리는 전혀 다른 값이 나올 수 있어서 주의해야 한다. 왜냐하면 CPU,메모리는 가상서버에서 공유되는게 일반적이기 때문이다. 또한 CPU, 메모리는 한번 세팅되면 왠만하면 물리적 구성이 변경되지 않는데 반해 VM에서는 쉽게 추가되거나 제거되기 때문에 이런 차이점을 이해하고 있어야 한다.  
다행히도 주요 VM공급업체들이 시스템과 SQL Server에 대한 추가 모니터링 방법을 제공한다. 가장 일반적인 두가지 하이퍼바이저안 VMWare와 Hyper-V에 대한 참고 문서는 다음과 같다.

    * VMWare 성능 모니터링 안내(http://bit.ly/1f37tEh)
    * Hyper-V 성능 모니터링 안내(http://bit.ly/2y2U6Iw)

processor queue length와 같은 queue 카운터들은 VM에서도 그대로 적용된다. 이는 VM 자체 리소스 부족이 근본 원인이 되는 경우 SQL Server 리소스도 부족하게 되며 가상CPU에 대한 대기를 한다는것을 뜻하기 때문이다. 기억해야 할 것은 VM관리가 시스템 리소스를 방해하기 때문에 VM에서 CPU와 메모리가 잠재적으로 느려질수 있다는 것이다. 또한 호스팅된 리소스의 공유 특성 때문에 I/O가 느려질 수도 있다.

또한 Azure SQL Database 및 SQL Server 2016 이상의 모든 인스턴스 (쿼리 저장소라고 함) 내에 기본 제공 자동화 된 기본 메커니즘이 있다. 11 장에서 쿼리 저장소에 대해 자세히 다룰 것입니다.

시스템이 어떻게 작동하는지 이해하는 데 사용할 수있는 또 다른 메커니즘은 DMV입니다. 캐시, 재부팅, 장애 조치 및 기타 메커니즘에 따라 너무 많이 변경되므로 기준선과 동일한 것으로 간주하기는 어렵습니다. 그러나 쿼리 성능의 집계보기를 볼 수있는 방법을 제공합니다. 6 장과 책의 나머지 부분에서 더 자세히 다룰 것입니다.

## 7.2 Baseline 생성
몇가지 주요 성능 카운터를 살펴 보고 이것들을 모아서 시스템의 베이스라인 데이터를 만들어 보자.

    a. 재사용 가능한 성능 카운터 리스트 만들기
    b. 성능카운터 리스트를 사용한 카운터 로그 만들기
    c. 성능 모니터 오버헤드 최소화

### a. 재사용 가능한 성능 카운터 리스트 만들기
성능모니터 도구를 이용하여 성능 카운터들 수집  
<img src = "image/07/CounterLog00.PNG" width="45%">

    예제) SQLServer:Latches:Total Latch Wait Time(ms) 수집해보자

    a. 성능 모니터 도구를 열고 그래프 화면이 기본적으로 나오는데 툴바에서 + 버튼을 눌러 카운터를 추가할 수 있는 창 오픈.
       단축키 ctrl + N 을 눌러도 됨. 기본적으로 "<로컬 컴퓨터>"로 선택되어 있다.
    b. "다음 컴퓨터에서 카운터 선택"에서 SQLServer:Latches 카운터를 선택한다.
    c. 아래 화살표를 누르면 하위 카운터들이 나열되는데 "Total Latch Wait Time(ms)"를 선택.
    d. "선택한 개체의 인스턴스"에서 _Total이 기본적으로 선택되어 있고 "추가" 버튼을 누르면 오른쪽 영역(추가된 카운터)에 추가된다.
    e. "확인" 버튼을 눌러 최종 완료.    
  
재사용가능한 항목의 베이스라인을 만들때 아래와 같은 리스트를 반복해서 지정

    Object(Instance)                    Counter
    ----------------------------------  ----------------------------------------------------
    Memory                              Available MBytes
                                        Pages/sec
    PhysicalDisk(Data-disk, Logdisk)   % Disk Time
                                        Current Disk Queue Length
                                        Disk Transfers/sec
                                        Disk Bytes/sec     
    Processor(_Total)                   % Processor Time
                                        % Privileged Time
    System                              Processor Queue Length
                                        Context Switches/sec
    Network Interface(Network card)     Bytes Total/sec
    Network Segment                     % Net Utilization
    SQLServer:Access Methods            FreeSpace Scans/sec
                                        Full Scans/sec
    SQLServer:Buffer Manager            Buffer cache hit ratio
    SQLServer:Latches                   Total Latch Wait Time (ms)
    SQLServer:Locks(_Total)             Lock Timeouts/sec
                                        Lock Wait Time (ms)
                                        Number of Deadlocks/sec
    SQLServer:Memory Manager            Memory Grants Pending
                                        Target Server Memory (KB)
                                        Total Server Memory (KB)
    SQLServer:SQL Statistics            Batch Requests/sec
                                        SQL Re-Compilations/sec
    SQLServer:General Statistics        User Connections


모든 성능 카운터를 추가했으면 확인을 클릭하여 카운터 추가 대화 상자를 닫습니다. 카운터 목록을 .htm 파일로 저장하려면 성능 모니터의 오른쪽 프레임을 마우스 오른쪽 단추로 클릭하고 다른 이름으로 설정 저장 메뉴 항목을 선택합니다.

.htm 파일에는 카운터 로그를 만들거나 동일한 SQL Server 컴퓨터에 대한 성능 모니터 그래프를 대화 형으로보기 위해 기본 카운터 집합으로 사용할 수있는 모든 성능 카운터가 나열됩니다. 다른 SQL Server 컴퓨터에 대해이 카운터 목록을 사용하려면 메모장과 같은 편집기에서 .htm 파일을 열고 \\ SQLServerMachineName의 모든 인스턴스를 아무 것도없이 (빈 문자열 만) 바꿉니다.

이 모든 것에 대한 지름길은 Erin Stellato가 "성능 모니터에 대한 기본 카운터 사용자 지정"(http://bit.ly/1brQKeZ) 기사에서 설명합니다. 또한 Microsoft에서 제공하는 도구 인 PAL (Performance Analysis of Logs) (https://bit.ly/2KeJJmy)을 사용하여 이러한 데이터 중 일부를보다 쉽게 처리 할 수 있습니다.

또한이 카운터 목록 파일을 사용하여 그림 5-2와 같이 인터넷 브라우저에서 대화 형으로 성능 모니터 그래프를 볼 수 있습니다.
<성능카운터 캡처>

### b. 성능카운터 리스트를 사용한 카운터 로그 만들기
성능 모니터는 일정 기간 동안 여러 카운터의 성능 데이터를 저장하는 카운터 로그 기능을 제공합니다. 성능 모니터를 사용하여 저장된 카운터 로그를 보고 성능 데이터를 분석 할 수 있습니다. 일반적으로 정의 된 성능 카운터 목록에서 카운터 로그를 만드는 것이 편리합니다. GUI를 통해 데이터를 보는 것보다 단순히 데이터를 수집하는 것이 서버 성능 문제 해결을 준비하거나 기준을 설정하는 데 선호되는 자동화 방법입니다.

성능모니터 > 데이터 수집기 집합 > 사용자 정의 > 오른쪽 마우스 클릭 > 새로 만들기 > 데이터 수집기 집합  
이름을 지정하고 "수동으로 만들기(고급)" 을 선택하고 다음을 누른다.  
<img src = "image/07/CounterLog01.PNG" width="45%">

어떤 형식의 데이터를 선택하는 화면이 뜨는데 "성능 카운터" 선택하고 다음을 누른다.  
<img src = "image/07/CounterLog02.PNG" width="45%">

원하는 성능 카운터들을 추가하고 데이터를 수집할 샘플 간격을 초단위로 입력하고 다음을 누른다.  
<img src = "image/07/CounterLog03.PNG" width="45%">    

데이터를 저장할 폴더를 지정하고 다음을 누른다.  
<img src = "image/07/CounterLog04.PNG" width="45%">    

실행할 계정을 선택하거나(보통은 기본값) 기타 동작을 선택하고 마침을 누른다.  
<img src = "image/07/CounterLog05.PNG" width="45%">        

만들어진 데이터 수집기 집합인 SQLServerBaseline 을 오른쪽 클릭하고 속성 > 일정을 선택한다.  
다음과 같이 시작일정을 추가할수 있다.  
<img src = "image/07/CounterLogSchedule01.PNG" width="45%">

중지조건도 지정해 얼마만큼만 실행될지 정할수 있다.  
<img src = "image/07/CounterLogSchedule02.PNG" width="45%">     

결과가 이진파일이면서 파일명이 DataCollector01.blg 로 나오는데 다음과 같이 조정할 수 있다.  
만들어진 데이터 수집기 집합인 SQLServerBaseline을 선택하고 오른쪽 DataCollector01을 오른쪽 클릭 > 속성에서 로그형식을 "쉼표로 구분" 선택하면 csv의 텍스트 포맷으로 저장된다.  
<img src = "image/07/CounterLog06.PNG" width="45%">     

파일명 DataCollector01을 바꿀수 있다.  
<img src = "image/07/CounterLog07.PNG" width="45%">     


추가적인 성능 모니터 사용 지침을 사용해 좀더 자세한 내용을 살펴 볼수 있다.
[Windows Server 2022의 성능 튜닝 지침](https://docs.microsoft.com/ko-kr/windows-server/administration/performance-tuning/)

### c. 성능 모니터 오버헤드 최소화
성능 모니터는 오버헤드를 최소화하도록 만들어졌지만 그래도 시스템 영향을 적게 받게 하지 위해서 다음과 같은 고려사항이 있다.

    * 카운터 수를 제한. 정말로 1차적으로 필요한 것만 지정
    * 성능 모니터 그래프 기능보다는 카운터 로그 사용하여 데이터 수집
    * 그래프 기능 사용할 경우에는 원격으로 성능 모니터 접근
    * 물리적으로 별도의 디스크에 카운터 로그 저장
    * 샘플링 간격 늘리기

### * 카운터 수 제한
짧은 간격으로 많은 수의 카운터들을 수집하는 것은 시스템에 약간의 오버헤드가 추가될 수 있다. 이 오버헤드의 대부분은 추가한 성능 카운터 갯수에 의해 발생하므로 당신이 선택한 카운터들에 대해 자세히 알 필요가 있다. 
선택한 성능 개체에 대한 카운터 수는 개체 자체의 특성 만 제공하므로 오버 헤드를 많이 추가하지 않습니다. 따라서 모니터링하려는 개체와 그 이유를 아는 것이 중요합니다.

### * 카운터 로그 기능을 보다 우선하기
성능 모니터 그래프는 오버 헤드 측면에서 더 많은 비용이 들기 때문에 성능 모니터 그래프를 대화식으로 보는 대신 카운터 로그를 사용하십시오. 그래프로 현재 활동 모니터링 하는 것은 단기간 데이터보기, 문제 해결 및 진단으로 제한되어야 합니다. 카운터 로그를 통해 보고 된 성능 데이터는 샘플링됩니다. 즉, 데이터는 추적되지 않고 주기적으로 수집되는 반면 성능 모니터 그래프는 이벤트가 발생하면 실시간으로 업데이트됩니다. 카운터 로그를 사용하면 오버 헤드가 줄어 듭니다.

### * 원격으로 성능 모니터 그래프 보기
성능 모니터 그래프를 사용하여 실시간 성능 데이터를 보면 시스템에 상당한 오버 헤드가 발생하므로 다른 컴퓨터에서 원격으로 도구를 실행하고 도구를 통해 SQL Server 시스템에 연결합니다. SQL Server 컴퓨터에 원격으로 연결하려면 SQL Server 컴퓨터도 연결된 네트워크에 연결된 컴퓨터에서 성능 모니터 도구를 실행합니다.

컴퓨터에서 카운터 선택 상자에 SQL Server 컴퓨터의 컴퓨터 이름 (또는 IP 주소)을 입력합니다. Windows Server 2016 터미널 서비스 세션을 통해 프로덕션 서버에 연결하는 경우 도구의 주요 부분은 계속 서버에서 실행됩니다.

그러나 라이브 데이터를보기 위해 성능 모니터 그래프를 사용하지 않는 것이 좋습니다. 그래프를 사용하여 카운터 로그를 통해 수집 된 파일을 볼 수 있으며 이러한 로그를 사용하는 편향이 있어야합니다.

### * 카운터 로그 로컬로 저장
카운터 로그에 대한 성능 데이터를 수집해도 그래프를 표시하는 오버 헤드가 발생하지 않습니다. 따라서 카운터 로그 모드를 사용하는 동안 네트워크를 통해 성능 데이터를 전송하는 대신 SQL Server 시스템의 로컬로 카운터 값을 기록하는 것이 더 효율적입니다. 카운터 로그 파일은 모니터링되는 디스크가 아닌 로컬 디스크에 저장합니다. 즉, SQL Server 데이터 및 로그 파일을 의미합니다.

그런 다음 데이터를 수집 한 후 해당 카운터 로그를 로컬 컴퓨터에 복사하여 분석합니다. 이렇게하면 복사본에 대해서만 작업하고 스토리지 위치에 I / O 오버 헤드를 추가하지 않습니다.

### * 샘플링 간격 늘리기
기본 모니터링 중 리소스 사용 패턴에 주로 관심이 있기 때문에 성능 데이터 샘플링 간격을 60 초 이상으로 쉽게 늘려 로그 파일 크기를 줄이고 디스크 I / O에 대한 수요를 줄일 수 있습니다. 짧은 샘플링 간격을 사용하여 타이밍 문제를 감지하고 진단 할 수 있습니다. 보는 동안에도
성능 모니터는 대화식으로 그래프를 작성하고 샘플 당 기본값 인 1 초에서 샘플링 간격을 늘립니다. 샘플링 크기를 위 또는 아래로 변경하면 데이터의 세분성과 수량에 영향을 미칠 수 있습니다. 당신은 무게를 신중하게 선택하십시오.

## 7.3 Baseline 데이터를 바탕으로 시스템 활동 분석
데이터베이스 애플리케이션의 기본 동작은 다음과 같은 다양한 요인으로 인해 시간이 지남에 따라 시시각각 변화한다.

    * 데이터 볼륨과 배포 변화
    * 사용자 기반 증가
    * 어플리케이션 사용 패턴의 변화
    * 응용 프로그램 동작의 추가 또는 변경
    * 새 서비스 팩 또는 소프트웨어 업그레이드 설치
    * 하드웨어 변경

이러한 변경으로 인해 데이터베이스 서버에 대해 생성 된 기준선의 중요성이 서서히 손실됩니다. 시스템의 현재 동작을 이전 기준과 비교하는 것이 항상 정확한 것은 아닙니다. 따라서 정기적 인 시간 간격으로 새 기준선을 만들어 기준선을 최신 상태로 유지하는 것이 중요합니다. 필요한 경우 나중에 참조 할 수 있도록 이전 기준 로그를 아카이브하는 것도 유용합니다. 예, 예전 기준은 일상적인 작업에 적용 할 수 없지만 패턴과 장기적인 추세를 설정하는 데 도움이됩니다.

다음 단계에 따라 성능 모니터 도구를 사용하여 기준 또는 시스템의 현재 동작에 대한 카운터 로그를 분석 할 수 있습니다.

    1. 카운터 로그를 엽니다.
       성능 모니터의 도구 모음 > 로그 데이터보기 > 로그 파일의 이름을 선택합니다. 또는 단축키 (ctrl + L)  
<img src = "image/07/PerfMon01.PNG" width="60%">     
<img src = "image/07/PerfMon02.PNG" width="50%">     


    2. 데이터 탭을 눌러 화면에 보여주고 싶은 성능 데이터를 추가하여 분석합니다. 카운터 로그를 생성하는 동안 수집한 성능 개체, 카운터 및 인스턴스 만 선택 목록에 표시됩니다.
<img src = "image/07/PerfMon03.PNG" width="50%">         
<img src = "image/07/PerfMon04.PNG" width="50%">         
<img src = "image/07/PerfMon05.PNG" width="50%">
<img src = "image/07/PerfMon06.PNG" width="50%">   

    3. 아래 그림과 같이 시간 범위를 적절히 조정하여 하루 중 다른 부분의 시스템 동작을 분석합니다.
<img src = "image/07/PerfMon07.PNG" width="50%">     


성능 검토 중에 성능 카운터의 현재 값을 최신 기준과 비교하여 데이터베이스의 시스템 수준 동작을 분석 할 수 있습니다. 성능 데이터를 비교할 때 다음 사항을 고려하십시오.

    * 두 경우 모두 동일한 성능 카운터 집합을 사용하십시오.
    * 개별 카운터에 적용 할 수있는 카운터의 최소, 최대 및 평균 값을 비교합니다. 카운터의 특정 값을 앞서 설명했습니다.
    * 일부 카운터에는 확실한 좋은 / 나쁜 값이 없습니다. 그 값은 응용 프로그램에 따라 다르기 때문에 해당 기준 카운터와의 상대적 비교는 필수입니다. 예를 들어 SQL Server에 대한 User Connections 카운터의 현재 값은 응용 프로그램의 좋은 점이나 나쁜 점을 나타내지 않습니다. 그러나 해당 기준 값과 비교하면 사용자 연결 수가 크게 증가하여 워크로드가 증가 함을 알 수 있습니다.
    * 현재 카운터 로그와 기준 카운터 로그에서 카운터 값 범위를 비교합니다. 카운터의 개별 값의 변동은 값 범위에 의해 정규화됩니다.
    * 같은 날의 로그를 비교합니다. 대부분의 애플리케이션에서 사용 패턴은 하루 중 다른 부분에 따라 다릅니다. 특정 시간 동안 카운터의 최소, 최대 및 평균 값을 얻으려면 이전에 표시된대로 카운터 로그의 시간 범위를 조정하십시오.

시스템 수준 병목 현상이 확인되면 응용 프로그램의 내부 동작을 분석하여 병목 현상의 원인을 확인해야합니다. 병목 현상의 원인을 식별하고 최적화하면 시스템 리소스를 효율적으로 사용하는 데 도움이됩니다.

## 7.4 Azure SQL Database의 베이스라인
물리적 상자 및 VM에서 실행되는 SQL Server 인스턴스에 대한 기준을 설정하려는 것과 마찬가지로 Azure SQL Database의 성능에 대한 기준이 있어야합니다. 이에 대한 성능 모니터 측정 항목을 캡처 할 수 없습니다. 또한 Azure SQL Database는 가상 머신 또는 물리적 서버로 표시되지 않습니다. 서비스로서의 데이터베이스입니다. 따라서 CPU 또는 디스크 사용량을 측정하지 않습니다. 대신 Microsoft는 DTU (데이터베이스 트랜잭션 단위)라는 성능 측정 단위를 정의했습니다. 시간이 지남에 따라 데이터베이스의 DTU 동작을 관찰 할 수 있습니다.

DTU는 I / O, CPU 및 메모리의 혼합 측정으로 정의됩니다. 이름에서 알 수 있듯이 리터럴 트랜잭션을 나타내는 것이 아니라 서비스 내 데이터베이스 성능의 척도입니다. CPU 사용량과 스토리지 데이터를 확인하는 방법으로 sys.resource_stats를 쿼리 할 수 있습니다. 14 일 실행 기록을 유지하고 5 분 간격으로 데이터를 집계합니다.

Azure Portal은 DTU 사용을 관찰하기위한 메커니즘을 제공하지만 기준을 설정하는 메커니즘은 제공하지 않습니다. 대신 Azure SQL Database 관련 DMV sys.dm_db_resource_stats를 사용해야합니다. 이 DMV는 지정된 Azure SQL Database의 DTU 사용량에 대한 정보를 유지합니다. 15 분 단위로 1 시간 분량의 정보를 포함합니다. SQL Server 인스턴스에서와 같이 기준을 설정하려면 시간이 지남에 따라이 데이터를 캡처해야합니다. sys.dm_db_resource_stats에 표시된 정보를 테이블로 수집하면 Azure SQL Database의 성능 메트릭에 대한 기준을 설정할 수 있습니다.

Azure SQL Database에는 기본적으로 쿼리 저장소가 활성화되어 있으므로이를 사용하여 시스템에서 일어나는 일을 이해할 수 있습니다.

## 7.5 요약
이 장에서는 성능 모니터 도구를 사용하여 SQL Server의 전반적인 동작과 성능이 느린 데이터베이스 응용 프로그램이 시스템 리소스에 미치는 영향을 분석하는 방법을 배웠습니다. 또한 서버 및 데이터베이스 모니터링의 일부로 기준선 설정에 대해서도 배웠습니다. 이러한 도구를 사용하면 표준 동작에서 벗어나는시기를 이해할 수 있습니다. 데이터가 부실하지 않도록 정기적으로 기준을 수집하는 것이 좋습니다.

다음 장에서는 성능 튜닝을 위해 데이터베이스 애플리케이션의 워크로드를 분석하는 방법을 배웁니다.